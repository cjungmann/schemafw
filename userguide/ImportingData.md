# Importing Data

## Overview

Importing data in SchemaFW is a multi-step process, accepting data from several
popular spreadsheet formats.  It is designed to provide data security by providing
an opportunity for the user and the application to validate uploaded data before
it is integrated into an application's general data.

### Steps to Import

1. **_form-import_ response mode**  The user submits a file to upload in a special
   [multipart/form-data](https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.2)
   encoded form.  This form can be generated by SchemaFW or be a hard coded HTML page.

2. **_import_ response mode**  This mode is the target of the import form.  This mode
   is unusual in that it does not reference a procedure, but instead includes a
   _jump_ instruction to redirect the user to the next step.

3. **_import-review_ response mode**  The uploaded data is mirrored back to the user
   as a table view via an _import-review_ response mode.  The user can compare the
   columns' data with the column heads to confirm that the data matches what the
   application intends to use it for.  The _import-review_ response mode must include
   two URLs, one URL for accepting the data and another for abandoning it.  These
   URLs will be used to render the buttons that the user needs to make the choice.

4. **_import-verdict_ response modes**  There must be two verdict response modes,
   representing the accept and abandon options.  Each will include a _procedure_
   instruction for executing the user's choice, and an optional _jump_ instruction
   to direct the user to a new page.  The _jump_ instruction is optional, it may
   be that the import steps are a dead-end window that is closed to reveal the

   Abandoning the data simply deletes the staged data, while accepting the data
   calls an application-defined stored procedure that integrates the data with the
   general storage.  The acceptance procedure can be as simple as directly inserting
   the data directly into other tables, or as involved as running data security
   checks, eliminating duplicate records, etc,  before inserting or updating
   to one or more tables.

## Setup For Importing

### System Setup

Besides the Schema Framework installation, the only additional software required
for importing data is the _ssconvert_ utility that comes bundled with
[Gnumeric](www.gnumeric.org).  Install Gnumeric with the following command:

~~~
sudo apt-get install gnumeric
~~~

To see the list of import formats supported by _ssconvert_:

~~~
ssconvert --list-importers
~~~

### MySQL Setup

The webuser account must have _FILE_ privileges

For each import page, there must be a __quarantine table__ in which the uploaded
data will be staged ahead accepting or abandoning the data.  The quarantine table
must include an indexed, unsigned int first column named _id_session_, and then
the order of the remaining field must match the order of the columns in the
spreadsheet.

The field names, except for the first _id_session_ field, are significant only
for the _import-review_ page, where the field names serve as column headers.  The
data is inserted in the quarantine table in spreadsheet order without regard to
the column headings.

**Important note:** The webuser account have global _FILE_ privileges, and must be
granted _INSERT_ privileges on the quarantine table.  This will be shown in the
example below.

  ~~~sql
  CREATE TABLE QT_Contacts
  (
     id_session INT UNSIGNED,
     fname      VARCHAR(32),
     lname      VARCHAR(32),
     phone      VARCHAR(25),
     INDEX(id_session)
  );
  GRANT INSERT ON QT_Contacts TO 'webuser'@'localhost';

  -- Remember to grant FILE access to the default user:
  GRANT FILE ON *.* to 'webuser'@'localhost';
  ~~~
  
- An **removal procedure** to delete the uploaded records from the quarantine table.
  This procedure will be used both for the _import-verdict_ response mode that handles
  an abandon request and also for cleaning up after an accept request.

  Do **not** use TRUNCATE TABLE to remove the records.  The quarantine table
  includes staged records from all users who are uploading data, as distinguished
  by the _id_session_ field.  

  ~~~sql
  CREATE PROCEDURE App_Contacts_Upload_Remove(session_id INT UNSIGNED)
  BEGIN
     DELETE
       FROM QT_Contacts
      WHERE id_session = @session_confirmed_id;
  END $$
  ~~~
  
- An **accept procedure** that incorporates the data once it's been accepted.
  Although the example below only uses a single INSERT query, other applications
  might run several queries (in a single stored procedure) to update multiple
  tables.  After the data has been incorporated, the quarantine records
  should be deleted because they typically should no longer be needed.

  This example uses a CALL to the removal procedure to discard the
  records once they have been incorporated.  This may not always be
  appropriate, but in the majority of cases, using the removal procedure
  in this context helps prevent surprises when removal is not a trivial
  procedure.

  ~~~sql
  CREATE PROCEDURE App_Contacts_Upload_Accept(session_id INT UNSIGNED)
  BEGIN
     INSERT INTO Contact (fname, lname, phone)
     SELECT fname, lname, phone
       FROM QT_Contacts
      WHERE id_session=@session_confirmed_id;

    CALL App_Contacts_Upload_Remove(session_id);
  END $$
  ~~~

### HTML Resources

Although an _import-form_ response mode will generate an appropriate importing
form, some users will need to hard-code their import form.  Use the following
example to guide the essential parts of an import form.

~~~html
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>File Upload Test/Demonstration</title>
  </head>
  <body>
    <h1>File Upload Test/Demonstration</h1>
    <p>Let's try to do a multipart form for a file upload.</p>
    <form method="post"
          action="import.srm?upload"
          enctype="multipart/form-data">
      <fieldset>
        <legend>Upload a CSV file</legend>
        <div>
          <label for="upfile">Upload the file</label>
          <input type="file" name="upfile" />
        </div>
        <div>
          <input type="submit" value="Submit"/>
        </div>
      </fieldset>
    </form>
  </body>
</html>
~~~



## The Response Mode

The response mode of an import operation is unique in that it does not
include a _procedure_ or _schema-proc_ operation.  Here is an example:

~~~srm
# SRM file import.srm

import_contacts
   type   : import-form
   schema
      form-action: import.srm?import

import
   type   : import
   target : QT_People  # Name the quarantine table in a target instruction
   jump   : import.srm?confirm

confirm
   type        : import-review
   abandon-url : import.srm?abandon
   accept-url  : import.srm?accept
   schema

abandon
   type      : import-verdict
   procedure : App_Contacts_Upload_Remove
   jump      : default.srm?home

accept
   type      : import-verdict
   procedure : App_Contacts_Upload_Accept
   jump      : default.srm?home

~~~