# Importing Data

## Overview

Importing data in SchemaFW is a multi-step process, accepting data from several
popular spreadsheet formats.  It is designed to provide data security by providing
an opportunity for the user and the application to validate uploaded data before
it is integrated into an application's general data.

As a multi-step, it is necessary to have some sort of session running, so the
progress can be tracked and displayed.  A simple session is sufficient.  See
[Session Overview](SessionOverview.md) for an explanation of how to use sessions.

When upload data is not immediately incorporated into the application, it must
be saved to a quarantine table to be shown to the user for validation (see step 2
below).  This table must be managed to prevent access by other users.  The current
suggested practice is to create a clean-up procedure that will delete records by
session_id  Refer to the procedure below *App_Contacts_Upload_Abandon*.  This
procedure should be called at three events:

- Before importing, in case a previous import left the records,
- After the user decides to accept or abandon the import, and
- When the session ends.

### Steps to Import

1. **_form-import_ response mode**  The user submits a file to upload in a special
   [multipart/form-data](https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.2)
   encoded form.  This form can be generated by SchemaFW or be a hard coded HTML page.

2. **_import_ response mode**  This mode is the target of the import form.  This
   mode is unusual in that it does not reference a procedure, but rather a target
   _Quarantine Table_ into which the uploaded data will be staged.  Jump to an
   _import-review_ response mode (step 3 below) to allow the user to confirm the
   data.

3. **_table_ response mode**  (previously _import-review_)  Display the uploaded
   import data in a format that makes it easy to confirm that it was interpreted
   as expected.  In most cases, this will be a table view, though the developer
   is free to use any mode-type that helps the user validate the data.  Two buttons
   should be defined, one to accept the upload and incorporate the data, and another
   button to abandon the upload, discarding the contents of the quarantine table.

   Using a table example, if the client has the columns in the wrong order, it
   should be obvious when a column of client names falls under a column named
   *date_of_birth*.  It is obvious, in that case, that the import document need
   to be reformatted and resubmitted.

4. **_import-verdict_ response modes**  There should be two verdict response modes,
   representing the accept and abandon options.  Each will include a _procedure_
   instruction for executing the user's choice, and an optional _jump_ instruction
   to direct the user to a new page, most likely the page that includes the newly
   imported data.

   Abandoning the data simply deletes the staged data, while accepting the data
   calls an application-defined stored procedure that integrates the data with the
   general storage.  The acceptance procedure can be as simple as directly inserting
   the data directly into other tables, or as involved as running data security
   checks, eliminating duplicate records, etc,  before inserting or updating
   to one or more tables.

## Setup For Importing

### System Setup

Besides the Schema Framework installation, the only additional software required
for importing data is the _ssconvert_ utility that comes bundled with
[Gnumeric](www.gnumeric.org).  Install Gnumeric with the following command:

~~~
sudo apt-get install gnumeric
~~~

To see the list of import formats supported by _ssconvert_:

~~~
ssconvert --list-importers
~~~

### Old Instructions

This [unmaintained page](ImportingFiles.md) includes some instructions and explanations that
were thought to be unncessary when this page was being written.  The old page is kept in
case I overlooked something necessary, but it has been removed from the [index](UserGuide.md).

### MySQL Setup

The webuser account must have _FILE_ privileges

For each import page, there must be a __quarantine table__ in which the uploaded
data will be staged ahead accepting or abandoning the data.  Because the quarantine
table is shared by all users, a session id column must be included in the quarantine
table's data definition to distinguish uploads from the several users.

The field names, except for the first *id_session* field, are significant only
for the *import-review* page, where the field names serve as column headers.  The
data is inserted in the quarantine table in spreadsheet order without regard to
the column headings.

**Important note:** The webuser account have global _FILE_ privileges, and must be
granted _INSERT_ privileges on the quarantine table.  This will be shown in the
example below.

**Security Node:** Common practices discourage allowing _FILE_ privileges to a web user
because it may introduce risks of abuse.  The SchemaFW secures against misuse of _FILE_
privileges by refusing to import any file unless the filename is '-'.  This is not a valid
filename, so it can't refer to a real file, but the C++ code disregards the filename
(besides signalling an error if it isn't '-') and reads the data directly from stdin.
Refer to the source code in file _mysql_loaddata.cpp__, *MySQL_LoadData::import(void)*
in particular, if this explanation doesn't reassure you.

  ~~~sql
  CREATE TABLE QT_Contacts
  (
     id_session INT UNSIGNED,
     fname      VARCHAR(32),
     lname      VARCHAR(32),
     phone      VARCHAR(25),
     INDEX(id_session)
  );
  GRANT INSERT ON QT_Contacts TO 'webuser'@'localhost';

  -- Remember to grant FILE access to the default user:
  GRANT FILE ON *.* to 'webuser'@'localhost';
  ~~~

- A **review procedure** to show the uploaded information to help the user
  confirm an accurate upload.

  ~~~sql
  CREATE PROCEDURE App_Import_Review()
  BEGIN
     SELECT fname, lname, phone
       FROM QT_Contacts
      WHERE id_session = @session_confirmed_id;
  END $$
  ~~~
  
- A **removal procedure** to delete the uploaded records from the quarantine table.
  This procedure will be used both for the _import-verdict_ response mode that handles
  an abandon request and also for cleaning up after an accept request.

  Do **not** use TRUNCATE TABLE to remove the records.  The quarantine table
  includes staged records from all users who are uploading data, as distinguished
  by the *id_session* field.  

  ~~~sql
  CREATE PROCEDURE App_Contacts_Upload_Abandon()
  BEGIN
     DELETE
       FROM QT_Contacts
      WHERE id_session = @session_confirmed_id;
  END $$
  ~~~
  
- An **accept procedure** that incorporates the data once it's been accepted.
  Although the example below only uses a single INSERT query, other applications
  might run several queries (in a single stored procedure) to update multiple
  tables.  After the data has been incorporated, the quarantine records
  should be deleted because they typically should no longer be needed.

  This example uses a CALL to the removal procedure to discard the
  records once they have been incorporated.  This may not always be
  appropriate, but in the majority of cases, using the removal procedure
  in this context helps prevent surprises when removal is not a trivial
  procedure.

  ~~~sql
  CREATE PROCEDURE App_Contacts_Upload_Integrate()
  BEGIN
     INSERT INTO Contact (fname, lname, phone)
     SELECT fname, lname, phone
       FROM QT_Contacts
      WHERE id_session=@session_confirmed_id;

    CALL App_Contacts_Upload_Abandon();
  END $$
  ~~~

### HTML Resources

Although an _import-form_ response mode will generate an appropriate importing
form, some users will need to hard-code their import form.  Use the following
example to guide the essential parts of an import form.

~~~html
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>File Upload Test/Demonstration</title>
  </head>
  <body>
    <h1>File Upload Test/Demonstration</h1>
    <p>Let's try to do a multipart form for a file upload.</p>
    <form method="post"
          action="import.srm?upload"
          enctype="multipart/form-data">
      <fieldset>
        <legend>Upload a CSV file</legend>
        <div>
          <label for="upfile">Upload the file</label>
          <input type="file" name="upfile" />
        </div>
        <div>
          <input type="submit" value="Submit"/>
        </div>
      </fieldset>
    </form>
  </body>
</html>
~~~



## The Response Mode

The response mode of an import operation is unique in that it does not
include a _procedure_ or _schema-proc_ operation.  Here is an example:

~~~srm
# SRM file import.srm

# Some sort of session is required for the user to have a confirmation stage:
$session-type : simple

import_contacts
   type        : form-import
   form-action : ?import

import
   type   : import
   target : QT_People  # Name the quarantine table in a target instruction
   jump   : ?review

review
   type      : table
   procedure : App_Import_Review
   intro     : Please review the uploaded data.  Confirm that the data in each
               column matches the descriptive name in the column head.  Click the
               Accept button to integrate the upload into your data, or click
               Abandon to discard the upload.
   button
      type  : jump
      label : Accept
      url   : ?accept
   button
      type  : jump
      label : Abandon
      url   : ?abandon

accept
   type      : import-verdict
   procedure : App_Contacts_Upload_Integrate
   jump      : default.srm?home  # Full URL needed to jump to another SRM file

abandon
   type      : import-verdict
   procedure : App_Contacts_Upload_Abandon
   jump      : default.srm?home

~~~