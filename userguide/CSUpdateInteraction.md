# Case Study Update Interaction

This interaction is meant to be called as the result of an `on_line_click`
instruction of a table (List) view.  The framework will append the record
id

## The Two Steps of Update Interactions

An update interaction, like a create interaction, consists of two steps,
implemented with two response modes:

1. a _form request_ mode to present a form, and

2. a _form submit_ mode for accepting the input.

Although the _form_submit_ mode is no different from a **create** interaction,
the _form-edit_ mode should provide data to fill in the form fields along with
the schema that both **create** and **update** interactions use to render the
form.

## MySQL Stored Procedures

A typical **update** interaction also uses two procedures,

1. An _update_ procedure that stores changes to the database.  This procedure
   will be used both for updating _and_ as a template for generating the schema
   that will be used to render the form, and

2. A _value_ procedure that returns the values that populate the form's fields.

### The Update Procedure

This parameters of this procedure are used first in the _form-edit_ response
mod to create the schema, then it is called in the _form-submit_ response
with the data from the form submission.

The procedure should return data that the mode will mark as an _update_-type
result that should be used to replace the table row that was clicked to initiate
the **update** interaction.  Ideally, the procedure does this by calling the same
procedure that the **list** interaction used to generate the table, but it could
also run a direct query or even ignore this guideline.  If there is no _update_
result, the table row will be left as-is.  See [the list interaction example]
(CSListInteraction.md).

~~~sql
CREATE PROCEDURE App_Contact_Update(id INT UNSIGNED,
                                    fname VARCHAR(32),
                                    lname VARCHAR(32),
                                    phone VARCHAR(10))
BEGIN
   UPDATE ContactList c
      SET c.fname = fname,
          c.lname = lname,
          c.phone = phone
    WHERE c.id = id;

   -- For the update result
   IF ROW_COUNT() > 0 THEN
      CALL App_Contact_List(id);
   END IF;
END $$
~~~

### The Value Procedure

This procedure is closely-linked to the _update_ procedure because it must a return
single data row whose fields match the name and type of the parameters of the _update_
procedure.  Form fields can also be filled with [context references]
(ContextReferences.md), but the _value_ procedure is the primary source of field
contents.

~~~sql
CREATE PROCEDURE App_Contact_Value(id INT UNSIGNED)
BEGIN
   SELECT c.id,
          c.fname,
          c.lname,
          c.phone
     FROM ContactList c
    WHERE c.id = id;
END $$
~~~

## Response Modes

Dialog interactions like **C**reate and **U**pdate require two response modes,
the first to return the schema for building the form, and second to accept
the data to submit it to MySQL.

### Form Request Response Mode

Before users can submit a form, they must know what fields the form defines.
Note that the following example includes both _schema-proc_ and _procedure_
instructions.  As described in [Create Interaction](CSCreateInteraction.md),
_schema-proc_ provides the schema for rendering the form, and additionally
for **u**pdate, the _procedure_ instruction calls a _value_ procedure (see above)
for the form fields.

The editing form generated by a _form request_ response mode is the appropriate
place to offer a **d**elete option.  The steps to add a **d**elete option are
described in [Delete Interaction](CSDeleteInteraction.md).

~~~srm
# Excepted from contacts.srm
edit
   type        : form-edit
   schema-proc : App_Contact_Update
   procedure   : App_Contact_Value
   form-action : contacts.srm?edit_submit
~~~



### Form Submit Response Mode

When the form is filled out and the user clicks _Submit_, the data is sent to the
form submit response URL defined in the _form-action_ instruction of the form
request response.  The following response mode defines the interaction:

~~~srm
# Excepted from contacts.srm
edit_submit
   type      : form-submit
   procedure : App_Contact_Update
   result
      type : update
~~~

Conceptually, one would not access this interaction directly, but rather
through the SchemaFW application framework.



## Links

[L-CRUD Interactions](LCRUDInteractions.md)

[Introduction to SchemaFW](IntroductionToSchemaFW.md)

[Main Page](UserGuide.md)

